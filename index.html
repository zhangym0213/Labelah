<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>视频与 JSON 编辑</title>
    <style>
        body {
            display: flex;
            flex-direction: row;
            font-family: Arial, sans-serif;
        }
        .container {
            padding: 10px;
        }
        #videoContainer {
            width: 60%;
        }
        #jsonContainer {
            width: 40%;
        }
        select, input, button {
            margin: 5px;
        }
        textarea {
            width: 100%;
            height: 300px;
        }
    </style>
</head>
<body>

    <!-- 视频选择部分 -->
    <div class="container" id="videoContainer">
        <h2>视频选择</h2>
        <input type="text" id="videoSearch" placeholder="搜索视频">
        <select id="videoSelect"></select>
        <video id="videoPlayer" width="100%" controls></video>
    </div>

    <!-- JSON 选择 & 编辑部分 -->
    <div class="container" id="jsonContainer">
        <h2>JSON 编辑</h2>
        <input type="text" id="jsonSearch" placeholder="搜索 JSON 文件">
        <select id="jsonSelect"></select>

        <h3>筛选条件</h3>
        <label>Video:</label>
        <select id="filterVideo"></select>
        <label>Source:</label>
        <select id="filterSource"></select>
        <label>Task:</label>
        <select id="filterTask"></select>

        <h3>JSON 数据</h3>
        <textarea id="jsonEditor"></textarea>
        <button onclick="saveJson()">保存 JSON</button>
    </div>

    <script>
        const repoOwner = "zhangym0213";  
        const repoName = "Labelah";  
        const videoFolder = "videos";  
        const jsonFolder = "data";  
        const token = "your-github-token";  

        // 加载视频文件列表
        async function loadVideos() {
            const response = await fetch(`https://api.github.com/repos/${repoOwner}/${repoName}/contents/${videoFolder}`);
            const data = await response.json();
            const videoSelect = document.getElementById("videoSelect");
            videoSelect.innerHTML = "";
            data.forEach(file => {
                if (file.name.endsWith(".mp4")) {
                    const option = document.createElement("option");
                    option.value = file.download_url;
                    option.textContent = file.name;
                    videoSelect.appendChild(option);
                }
            });
        }

        // 监听视频选择
        document.getElementById("videoSelect").addEventListener("change", function() {
            document.getElementById("videoPlayer").src = this.value;
        });

        // 加载 JSON 文件列表
        async function loadJsonFiles() {
            const response = await fetch(`https://api.github.com/repos/${repoOwner}/${repoName}/contents/${jsonFolder}`);
            const data = await response.json();
            const jsonSelect = document.getElementById("jsonSelect");
            jsonSelect.innerHTML = "";
            data.forEach(file => {
                if (file.name.endsWith(".json")) {
                    const option = document.createElement("option");
                    option.value = file.name;
                    option.textContent = file.name;
                    jsonSelect.appendChild(option);
                }
            });
        }

        let currentJsonFile = "";
        let currentJsonData = [];

        // 监听 JSON 选择
        document.getElementById("jsonSelect").addEventListener("change", function() {
            loadJson(this.value);
        });

        // 加载 JSON 文件内容
        async function loadJson(filename) {
            currentJsonFile = filename;
            const response = await fetch(`https://raw.githubusercontent.com/${repoOwner}/${repoName}/main/${jsonFolder}/${filename}`);
            const data = await response.json();
            currentJsonData = data;
            document.getElementById("jsonEditor").value = JSON.stringify(data, null, 2);
            populateFilters(data);
        }

        // 生成筛选选项
        function populateFilters(data) {
            const videoSet = new Set();
            const sourceSet = new Set();
            const taskSet = new Set();

            data.forEach(item => {
                if (item.Video) videoSet.add(item.Video);
                if (item.Source) sourceSet.add(item.Source);
                if (item.Task) taskSet.add(item.Task);
            });

            createDropdown("filterVideo", videoSet);
            createDropdown("filterSource", sourceSet);
            createDropdown("filterTask", taskSet);
        }

        // 生成下拉选项
        function createDropdown(id, values) {
            const select = document.getElementById(id);
            select.innerHTML = '<option value="">全部</option>';
            values.forEach(value => {
                const option = document.createElement("option");
                option.value = value;
                option.textContent = value;
                select.appendChild(option);
            });
        }

        // 监听筛选
        document.querySelectorAll("#filterVideo, #filterSource, #filterTask").forEach(select => {
            select.addEventListener("change", filterJson);
        });

        // 过滤 JSON
        function filterJson() {
            const video = document.getElementById("filterVideo").value;
            const source = document.getElementById("filterSource").value;
            const task = document.getElementById("filterTask").value;

            const filteredData = currentJsonData.filter(item =>
                (!video || item.Video === video) &&
                (!source || item.Source === source) &&
                (!task || item.Task === task)
            );

            document.getElementById("jsonEditor").value = JSON.stringify(filteredData, null, 2);
        }

        // 保存 JSON
        async function saveJson() {
            if (!currentJsonFile) {
                alert("请先选择 JSON 文件！");
                return;
            }

            const updatedContent = document.getElementById("jsonEditor").value;
            const encodedContent = btoa(unescape(encodeURIComponent(updatedContent)));

            const apiUrl = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${jsonFolder}/${currentJsonFile}`;

            // 获取最新 sha 值
            const res = await fetch(apiUrl);
            const fileData = await res.json();
            const sha = fileData.sha;

            const updateData = {
                message: `更新 JSON: ${currentJsonFile}`,
                content: encodedContent,
                sha: sha
            };

            const response = await fetch(apiUrl, {
                method: "PUT",
                headers: {
                    "Authorization": `token ${token}`,
                    "Accept": "application/vnd.github.v3+json",
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(updateData)
            });

            if (response.ok) {
                alert("JSON 文件已成功更新！");
                loadJson(currentJsonFile); // 更新后自动加载最新内容
            } else {
                alert("更新失败，请检查权限或 PAT 令牌！");
            }
        }

        // 页面加载时初始化
        loadVideos();
        loadJsonFiles();
    </script>

</body>
</html>
